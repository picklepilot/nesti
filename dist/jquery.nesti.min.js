/*
 *  nesti - v0.0.1
 *  A straight forward plugin for adding some very helpful functionalities to nested/tree structure checkbox lists.
 *  http://jkaczmar.com
 *
 *  Made by Justin Kaczmar
 *  Under MIT License
 */

!function(e,t,i,s){"use strict";var n="nesti",l={filterable:!1,useParentValueWhenFull:!1,filter:{css:{position:"sticky",top:0,width:"100%",padding:"6px 10px",border:"none",boxSizing:"border-box"}},listItem:{css:{display:"flex",alignItems:"center"}},collapse:{enabled:!1,speed:250,collapseTemplate:'<i class="fas fa-minus-circle text-smaller position-relative nesti-toggle nesti-toggle-collapse" style="font-size: .6rem;"></i>',expandTemplate:'<i class="fas fa-plus-circle text-smaller position-relative nesti-toggle nesti-toggle-expand" style="font-size: .6rem;"></i>'},onChange:null};function a(t,i){this.element=t,this.settings=e.extend(!0,{},l,i),this._defaults=l,this._name=n,this._targetId=this.element.id,this._html=[],this.init(),this.api={"api.collect":function(){let t=this,i=[];return this.settings.useParentValueWhenFull?(function s(n){[...n.find("> .list-item-template > input:checkbox")].forEach(n=>{if(t._isLeaf(e(n).closest(".looksee"))&&n.checked)i.push(n.dataset.value);else if(t._allChildrenChecked(e(n).closest(".looksee")))i.push(n.dataset.value);else{if(t._isLeaf(e(n).closest(".looksee")))return!1;s(e(n).parent().next().find("> .looksee"))}})}(this.tree.find("> .looksee")),i):Array.from(this.tree.find("input.leaf:checkbox:checked").map(function(){return this.dataset.value}))},"api.filter":function(e){this.filter(e)},"api.buildList":function(e,t=!1){this.buildList(e,t)},"api.reset":function(){this.tree.find("input:checkbox").prop("checked",!1),this.tree.find("input:checkbox").prop("indeterminate",!1)}}}e.extend(a.prototype,{init:function(){this.settings.filterable&&this._makeFilter(),this.tree=e(this.element),this._dressElement(),this.initHandlers()},_dressElement:function(){this.tree.css("list-style","none"),this.tree.find("ul").css("list-style","none")},initHandlers:function(){var t=this;e(t.element).find("input:checkbox").on("change",function(){var i=e(this).closest("li");t._isRoot(i)?t._lookForward(i):t._isLeaf(i)?t._lookBackward(i):(t._lookForward(i),t._lookBackward(i)),"function"==typeof t.settings.onChange&&t.settings.onChange.call()}),t._initToggleHandlers()},_initToggleHandlers:function(){var t=this;e(t.element).find(".nesti-toggle-collapse").on("click",function(){var i=e(this).closest("li");t.collapse(i)}),e(t.element).find(".nesti-toggle-expand").on("click",function(){var i=e(this).closest("li");t.expand(i)})},_makeFilter:function(){var t=this;e('<input type="text" class="form-control form-control-sm nesti-filter-input" placeholder="Find a filter.." id="'+this._targetId+'-filter-input" autocomplete="false">').css(t.settings.filter.css).insertBefore(this.element),e("#"+this._targetId+"-filter-input").on("keyup",function(){t.filter(e(this).val())})},_lookForward:function(t){var i=!!t.find("input:checkbox").first().prop("indeterminate")||t.find("input:checkbox").first().prop("checked");t.find("li").each(function(t,s){e(s).find("input:checkbox").prop("checked",i)})},_lookBackward:function(t){var i=this;t.parents("li").each(function(t,s){if(i._allChildrenChecked(e(s))?(e(s).find("input:checkbox").first().prop("checked",!0),e(s).find("input:checkbox").first().prop("indeterminate",!1)):i._someChildrenChecked(e(s))?e(s).find("input:checkbox").first().prop("indeterminate",!0):(e(s).find("input:checkbox").first().prop("checked",!1),e(s).find("input:checkbox").first().prop("indeterminate",!1)),"list"===e(s).parent().attr("id"))return!1})},_allChildrenChecked:function(e){return e.find("li").find('input[type="checkbox"]:checked').length>0&&e.find("li").find('input[type="checkbox"]:checked').length>0&&e.find("li").find('input[type="checkbox"]:checked').length===e.find("li").find('input[type="checkbox"]').length},_someChildrenChecked:function(e){var t=e.find("li").find("input:checkbox:checked").length;return t>0&&t!==e.find("li").find("input:checkbox").length},_isLeaf:function(e){return e.find("li").length<1},_isRoot:function(e){return e.parent("#"+this.element.id).length},filter:function(t){var i=this.tree.find("li");e(i).each(function(){var i=e(this).find("label").text();""===t?(e(this).css("visibility","visible"),e(this).fadeIn()):i.search(new RegExp(t,"i"))<0?(e(this).css("visibility","hidden"),e(this).fadeOut()):(e(this).css("visibility","visible"),e(this).fadeIn())})},collapse:function(e){e.find("ul").first().slideUp(this.settings.collapse.speed),e.find(".fa-minus-circle").first().replaceWith(this.settings.collapse.expandTemplate),this._initToggleHandlers()},expand:function(e){e.find("ul").first().slideDown(this.settings.collapse.speed),e.find(".fa-plus-circle").first().replaceWith(this.settings.collapse.collapseTemplate),this._initToggleHandlers()},buildList:function(t,s=!1){this._makeTier(t,s);var n=e(this._html.join(""));n.first("ul").attr("id",this.element.id),n.find(".list-item-template").css(this.settings.listItem.css),i.getElementById(this.element.id).innerHTML=n.html(),this._dressElement(),this.initHandlers()},_makeTier:function(e,t){this._html.push('<ul style="padding-left: 18px;">'),e.forEach((e,i)=>{this._html.push('<li class="looksee" id="'+this._slugify(e.label)+'-parent">'),this._html.push(this._listItemTemplate(e,i,t)),e.items&&this._makeTier(e.items,t),this._html.push("</li>")}),this._html.push("</ul>")},_listItemTemplate(t,i,s){return'<div class="list-item-template">'+(t.items&&this.settings.collapse.enabled?this.settings.collapse.collapseTemplate:"")+'<input class="'+(t.items?"":"leaf")+(this._isRoot(e(t))?"root":"")+'" id="'+this._slugify(t.label)+"-"+i+'" data-value="'+(s?t.label:t.value)+'" data-id="'+this._slugify(t.label)+"-"+i+'" type="checkbox" style="margin:4px;margin-left:8px;" '+(t.checked?"checked":"")+' /><label class="leaf-label" for="'+this._slugify(t.label)+"-"+i+'" style="margin-bottom:0;">'+t.label+"</label></div>"},_slugify:e=>e.toString().toLowerCase().replace(/\s+/g,"-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,"")}),e.fn[n]=function(t){var i,s=arguments;return void 0===t||"object"==typeof t?this.each(function(){e.data(this,"plugin_"+n)||e.data(this,"plugin_"+n,new a(this,t))}):"string"==typeof t&&"_"!==t[0]&&"init"!==t?(this.each(function(){var l=e.data(this,"plugin_"+n);l instanceof a&&"function"==typeof l.api[t]&&(i=l.api[t].apply(l,Array.prototype.slice.call(s,1))),"destroy"===t&&e.data(this,"plugin_"+n,null)}),void 0!==i?i:this):void 0}}(jQuery,window,document);